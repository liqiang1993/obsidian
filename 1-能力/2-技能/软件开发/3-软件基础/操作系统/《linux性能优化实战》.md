

# 开篇词

## 性能优化是最考验研发综合能力的工作之一

## 性能优化的学习成本很高，付出巨大的时间去积累实践是不可避免的，但努力只能决定下限，选择和方法决定上限，带着问题去学习，边学边实践，学习后能教别人，这样才是高效的学习。

# 如何学习性能优化

## 核心指标

### 用户视角

#### 吞吐量

#### 响应时延

### 系统视角

#### cpu

#### 内存

#### 磁盘io

#### 网络io

## 性能优化的步骤

### 梳理系统的性能指标维度

### 评估系统的指标目标

### 测试系统的指标现状

### 分析系统的性能瓶颈

### 给出性能优化方案并实施

### 性能指标的监控告警

## 学习性能优化的重点

### 建立系统性能的全局观

#### 掌握最基本的几个系统知识原理

##### 内存

##### 磁盘io

##### 网络io

#### 掌握必要的性能工具

#### 千万不要把性能工具当成学习的全部。工具只是解决问题的手段，关键在于你的用法。只有真正理解了它们背后的原理，并且结合具体场景，融会贯通系统的不同组件，你才能真正掌握它们

#### 通过实操，讲理论与工具使用融会贯通

## 怎样学更高效

### 建立知识体系，掌握关键知识的基本原理，不要陷入细节中

### 实操，实操，实操

### 反思，总结，改进，循环往复

# CPU篇

## 基础篇：到底应该怎么理解“平均负载”？

### 平均负载：平均活跃进程数

### 影响平均负载的因素

#### 正在执行的进程数

#### 可执行但在排队的进程数

#### 处于不可中断状态的进程数

#### 不可中断状态的进程则是正处于内核态关键流程中的进程，并且这些流程是不可打断的，比如最常见的是等待硬件设备的 I/O 响应，也就是我们在 ps 命令中看到的 D 状态（Uninterruptible Sleep，也称为 Disk Sleep）的进程

### 平均负载多少合理

#### 平均负载低于cpu数量的70%合理

### 平均负载与cpu使用率

#### 计算密集型、进程切换频繁型，负载高，cpu使用率也高

#### io密集型，负载高，cpu的使用率不高

### uptime

### mpstat

## 基础篇：经常说的 CPU 上下文切换是什么意思？

### cpu上下文

#### cpu寄存器，程序计数器

### cpu上下文切换

#### 任务切换时，将上一个任务的cpu上下文保存，加载新任务的cpu上下文加载到寄存器和程序计数器，并跳转到程序计数器所指的位置，继续执行

### 上下文切换的分类

#### 进程上下文切换

#### 进程的上下文不仅包括了虚拟内存、栈、全局变量等用户空间的资源，还包括了内核堆栈、寄存器等内核空间的状态

##### 进程的用户态

##### 进程的内核态

##### 用户态的进程调用系统接口进入内核态，发生两次cpu上下文转换

##### 系统调用过程通常称为特权模式转换，虽然不叫上下文切换，但实际上上下文切换是不可避免的

##### 进程是内核管理的，进程的切换只能发生在内核态

##### 切换的场景

-   分配的时间分片用完
    
-   主动sleep
    
-   运行依赖的资源暂时不可用
    
-   高优先级的任务插入
    
-   硬件中断
    

#### 线程上下文切换

##### 一个进程中至少含有一个线程

##### 线程切换时只要切换线程的寄存器、栈信息即可，更轻量，成本低

#### 中断上下文切换

##### 为快速响应硬件，中断切换比进程切换有更高的优先级

##### 中断切换发生时，只会发生在内核态，进程的内核上下文保存，用户上下文不用保存，中断结束后，原有的进程正常执行

### 上下文切换的影响

#### 过多的上下文切换，会把cpu浪费在上下文的频繁保存、恢复上，缩短了系统真正使用cpu的时间，导致系统的性能下降

### 怎样查看上下文切换指标

#### vmstat

#### pidstat

##### ，pidstat 默认显示进程的指标数据，加上 -t 参数后，才会输出线程的指标

#### sysbench

#### /proc/interrupts

#### watch

### 上下文切换指标的分类

#### 自愿上下文切换

#### 指的是进程无法获取运行所需的资源，导致的上下文切换， 如等待IO，内存资源不足等；

#### 被动上下文切换

#### 指的是进程因时间片用完等原因，被系统强制调度，发生上下文切换的情况，如进程竞争CPU；

## 基础篇：某个应用的CPU使用率居然达到100%，我该怎么办？

### CPU使用率

#### 1-cpu空闲时间/cpu总时间

### 相关的工具命令

#### top

#### ps

#### pidstat

#### perf

##### perf top -g -p 22314

##### perf record

##### perf report

#### ab(apache bench)

## 案例篇：系统的 CPU 使用率很高，但为啥却找不到高 CPU 的应用？

### pstree

### execsnoop

### 碰到常规问题无法解释的 CPU 使用率情况时，首先要想到有可能是短时应用导致的问题

#### 应用里直接调用了其他二进制程序，这些程序通常运行时间比较短，通过 top 等工具也不容易发现

#### 应用本身在不停地崩溃重启，而启动过程的资源初始化，很可能会占用相当多的 CPU

## 案例篇：系统中出现大量不可中断进程和僵尸进程怎么办？

### dstat

### strace

## 案例篇：系统的软中断CPU使用率升高，我该怎么办？

### sar

### 是一个系统活动报告工具，既可以实时查看系统的当前活动，又可以配置保存和报告历史统计数据

### hping3

### 是一个可以构造 TCP/IP 协议数据包的工具，可以对系统进行安全审计、防火墙测试等

### tcpdump

### 是一个常用的网络抓包工具，常用来分析各种网络问题

## 基础篇：怎么理解Linux软中断？

### Linux中的中断处理程序分为两部分

#### 上半部分对应硬件，特点是快速

## 如何快速分析出cpu的性能瓶颈

### cpu的性能指标

#### cpu使用率

#### 平均负载

#### 进程上下文切换

#### cpu缓存命中率

### 性能工具

#### 根据指标查工具

#### 根据工具查指标

### 分析cpu性能问题的套路

## cpu性能优化的几个思路

### 性能优化方法论

#### 怎样判断优化是否有效

#### 1.测试工具和目标程序要在不同的服务器上；2.优化前后的测试环境要一致；

##### 确定性能的量化指标

-   应用程序指标
    

-   吞吐量
    
-   响应时间
    

-   系统指标
    

-   cpu
    
-   内存
    
-   网络io
    
-   磁盘io
    

##### 确定优化前的性能指标

##### 确定优化后的性能指标

#### 决定优化哪部分指标呢

##### 二八原则：80%的代码都是由20%的代码导致的

##### 并不是所有的性能问题都值得优化

##### 优化瓶颈指标

#### 采用哪种方法优化呢

##### 简单、合适、投入产出比

### cpu优化的套路

#### 应用程序优化

##### 编译器优化

##### 算法优化

##### 异步处理

##### 多线程替换多进程

##### 善用缓存

#### 系统优化

##### CPU绑定

##### CPU独占

##### 优先级调整

##### 为进程设置资源限制

##### NUMA

##### 中断负载均衡

### 千万避免过早优化

# 内存篇

## 常用的linux命令行工具

### for

### awk

### sort

### smem

#### 用smem --sort swap命令可以直接将进程按照swap使用量排序显示

# 网络篇

## 套路篇：怎么评估系统的网络性能？

### 指标

### 工具

### 分层测试

## 套路篇：怎么评估系统的网络性能？

### dns解析的原理

### 工具

#### ping

#### nslookup

#### dig

#### pktgen

#### iperf

#### netperf

### 常见的 DNS 优化方法

#### 缓存

#### 预读取

#### httpdns

#### 全局dns负载均衡，返回地理位置最近的ip

## 案例篇：怎么使用 tcpdump 和 Wireshark 分析网络流量？

### tcpdump

#### 《TCP/IP 详解》，特别是第一卷的 TCP/IP 协议族, 这是每个程序员都要掌握的核心基础知识

### wireshark

## 案例篇：怎么缓解 DDoS 攻击带来的性能下降问题？

### dos

#### ddos

#### 带宽

#### 系统资源

#### 应用程序资源

### 模拟工具

#### hping3

## 案例篇：网络请求延迟变大了，我该怎么办？

### 工具

#### ping

#### traceroute

#### hping3的tcp\udp模式

#### curl

#### wrk

#### docker

### 延迟确认

#### 等待时间40ms

### nagle算法

### Nagle 算法规定，一个 TCP 连接上，最多只能有一个未被确认的未完成分组；在收到这个分组的 ACK 前，不发送其他分组

## 案例篇：如何优化 NAT 性能？（上）

### nat的分类

#### 静态nat

#### 动态nat

#### napt

##### snat

##### dnat

##### 双向地址转换

### netfilter框架

#### 数据流图

### 工具

#### iptables

## 案例篇：如何优化 NAT 性能？（下）

### systemtap

### conntrack

## 套路篇：网络性能优化的几个思路

### 指标

### 工具

### 通用套路

#### 定义指标

#### 指标目标

#### 指标现状

#### 分析差距并定位瓶颈

#### 给出优化方案

### 网络性能优化的方向

#### 应用程序

#### 套接字

#### 传输层

#### 网络层

#### 数据链路层
# 综合实战篇

## 案例篇：为什么应用容器化后，启动慢了很多？

### 工具

#### jq

### jvm的内存分配

### 容器的资源分配

## 案例篇：服务器总是时不时丢包，我该怎么办？

### 通过 ethtool 或者 netstat ，来查看网卡的丢包记录

#### 不过要注意，如果用 tc 等工具配置了 QoS，那么 tc 规则导致的丢包，就不会包含在网卡的统计信息中

### 网络层和传输层

#### netstat -s

#### sysctl net.netfilter.nf_conntrack_max

#### sysctl net.netfilter.nf_conntrack_count

#### iptables -nvL

##### iptables -t filter -nvL

#### tcpdump

### 子主题

## 案例篇：内核线程 CPU 利用率太高，我该怎么办？

### perf

### 火焰图

## 案例篇：动态追踪怎么用？

### 动态追踪的事件源

#### 静态探针

#### 动态探针

#### 硬件事件

### 动态追踪机制

#### ftrace

##### trace-cmd

#### perf

#### eBPF

#### SystemTap

#### BCC

#### sysdig

## 服务吞吐量下降很厉害，怎么分析？

### wrk

### ss

## 系统监控的综合思路